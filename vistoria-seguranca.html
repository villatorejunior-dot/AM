<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1e5631">
    <title>AM Engenharia - Vistoria de Seguran√ßa</title>
    <link rel="manifest" href="manifest.json">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-green: #013A0F;
            --light-green: #02781E;
            --yellow: #ffd700;
            --bg-gray: #f5f5f5;
            --border-gray: #ddd;
            --text-dark: #333;
            --danger-red: #dc3545;
            --warning-orange: #ff8c00;
            --success-green: #02781E;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-gray);
            color: var(--text-dark);
            overflow-x: hidden;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--light-green) 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-logo {
            height: 45px;
            width: auto;
            object-fit: contain;
        }

        .header-subtitle {
            font-size: 12px;
            opacity: 0.9;
            margin-top: 3px;
        }
        
        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Screens */
        .screen {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }
        
        .screen.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Form Styles */
        .form-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-dark);
            font-size: 14px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-gray);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-green);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        /* Button Styles */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }
        
        .btn-primary {
            background: var(--primary-green);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--light-green);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30, 86, 49, 0.3);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-danger {
            background: var(--danger-red);
            color: white;
        }
        
        .btn-block {
            width: 100%;
        }
        
        /* Checklist Layout */
        .checklist-layout {
            display: flex;
            gap: 0;
            height: calc(100vh - 80px);
        }
        
        /* Sidebar */
        .sidebar {
            width: 280px;
            background: white;
            border-right: 2px solid var(--border-gray);
            overflow-y: auto;
            flex-shrink: 0;
        }
        
        .sidebar-item {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-gray);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .sidebar-item:hover {
            background: var(--bg-gray);
        }
        
        .sidebar-item.active {
            background: var(--primary-green);
            color: white;
            font-weight: 600;
        }
        
        .sidebar-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--yellow);
        }
        
        .sidebar-item-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .sidebar-item-count {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .sidebar-item-progress {
            margin-top: 8px;
            height: 4px;
            background: rgba(0,0,0,0.1);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .sidebar-item-progress-bar {
            height: 100%;
            background: var(--success-green);
            transition: width 0.3s;
        }
        
        .sidebar-item.active .sidebar-item-progress {
            background: rgba(255,255,255,0.3);
        }
        
        .sidebar-item.active .sidebar-item-progress-bar {
            background: var(--yellow);
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: var(--bg-gray);
        }
        
        .section-header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .section-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--primary-green);
            margin-bottom: 5px;
        }
        
        .section-subtitle {
            font-size: 14px;
            color: #666;
        }
        
        /* Checklist Items */
        .checklist-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            border-left: 4px solid transparent;
            transition: all 0.3s;
        }
        
        .checklist-card.checked {
            border-left-color: var(--success-green);
        }
        
        .checklist-card.non-compliant {
            border-left-color: var(--danger-red);
            background: #fff5f5;
        }
        
        .checklist-item-header {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .checkbox-container {
            position: relative;
            flex-shrink: 0;
        }
        
        .checkbox-container input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: var(--success-green);
        }
        
        .checklist-item-text {
            flex: 1;
            font-size: 15px;
            line-height: 1.5;
        }
        
        .checklist-item-text strong {
            color: var(--primary-green);
        }
        
        /* Evaluation Buttons */
        .evaluation-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        .eval-btn {
            padding: 8px 16px;
            border: 2px solid var(--border-gray);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .eval-btn:hover {
            transform: translateY(-1px);
        }
        
        .eval-btn.active {
            border-color: var(--primary-green);
            background: var(--primary-green);
            color: white;
        }
        
        .eval-btn.conforme { border-color: var(--success-green); color: var(--success-green); }
        .eval-btn.conforme.active { background: var(--success-green); border-color: var(--success-green); }
        
        .eval-btn.nc { border-color: var(--danger-red); color: var(--danger-red); }
        .eval-btn.nc.active { background: var(--danger-red); border-color: var(--danger-red); }
        
        /* Observation Textarea */
        .observation-area {
            margin-bottom: 15px;
        }
        
        .observation-area textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-gray);
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }
        
        /* Photo Section */
        .photo-section {
            display: flex;
            gap: 10px;
            align-items: flex-start;
            flex-wrap: wrap;
        }
        
        .btn-photo {
            padding: 10px 18px;
            background: var(--primary-green);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .photo-preview {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .photo-item {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid var(--border-gray);
        }
        
        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .photo-delete {
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--danger-red);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            line-height: 1;
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
            justify-content: space-between;
            z-index: 90;
        }
        
        /* Progress Bar */
        .progress-container {
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }
        
        .progress-text {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .progress-bar-container {
            height: 12px;
            background: var(--border-gray);
            border-radius: 6px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-green), var(--light-green));
            transition: width 0.5s ease;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--primary-green);
            margin-bottom: 5px;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            border: 4px solid var(--border-gray);
            border-top: 4px solid var(--primary-green);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Hidden File Input */
        .file-input-hidden {
            display: none;
        }
        
        /* PDF Preview */
        #pdfPreview {
            width: 100%;
            height: 500px;
            border: none;
            display: block;
        }

        /* Mobile Adjustments */
        @media (max-width: 768px) {
            .header-logo {
                height: 35px;
            }

            #pdfPreview {
                height: 400px;
            }

            .sidebar {
                position: fixed;
                left: -280px;
                top: 60px;
                bottom: 0;
                z-index: 150;
                transition: left 0.3s;
            }
            
            .sidebar.mobile-open {
                left: 0;
            }
            
            .mobile-overlay {
                display: none;
                position: fixed;
                top: 60px;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 140;
            }
            
            .mobile-overlay.active {
                display: block;
            }
            
            .menu-toggle {
                position: fixed;
                bottom: 80px;
                right: 20px;
                width: 56px;
                height: 56px;
                background: var(--primary-green);
                color: white;
                border: none;
                border-radius: 50%;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 24px;
                z-index: 95;
            }
            
            .checklist-layout {
                flex-direction: column;
            }
            
            .main-content {
                padding: 15px;
            }
            
            .bottom-nav {
                padding: 12px 15px;
            }
        }
        
        /* Report Styles */
        .report-summary {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .summary-card {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            background: var(--bg-gray);
        }
        
        .summary-card-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .summary-card-label {
            font-size: 13px;
            color: #666;
        }
        
        .success-value { color: var(--success-green); }
        .danger-value { color: var(--danger-red); }
        .warning-value { color: var(--warning-orange); }
        
        /* Critical Issues */
        .critical-issues {
            background: #fff5f5;
            border: 2px solid var(--danger-red);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .critical-issues h3 {
            color: var(--danger-red);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .critical-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid var(--danger-red);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>
            <img src="WhatsApp Image 2025-11-07 at 09.54.47.jpeg" alt="AM Engenharia" class="header-logo">
            AM Engenharia
        </h1>
        <div class="header-subtitle">Sistema de Vistoria de Seguran√ßa do Trabalho</div>
    </div>

    <!-- Screen 1: Initial Form -->
    <div class="screen active" id="screen-initial">
        <div class="container">
            <div class="form-card">
                <h2 style="margin-bottom: 25px; color: var(--primary-green);">Nova Vistoria</h2>
                
                <div class="form-group">
                    <label>Nome do Empreendimento *</label>
                    <input type="text" id="nomeEmpreendimento" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>N√∫mero da Visita *</label>
                        <input type="number" id="numeroVisita" min="1" required>
                    </div>
                    <div class="form-group">
                        <label>Data</label>
                        <input type="text" id="dataVisita" placeholder="DD/MM/AAAA">
                    </div>
                </div>

                <div class="form-group">
                    <label>Hora de In√≠cio</label>
                    <input type="text" id="horaInicio" placeholder="HH:MM">
                </div>
                
                <div class="form-group">
                    <label>Engenheiro Vistoriador *</label>
                    <input type="text" id="engenheiroVistoriador" required>
                </div>
                
                <div class="form-group">
                    <label>Engenheiro Acompanhante</label>
                    <input type="text" id="engenheiroAcompanhante">
                </div>
                
                <div class="form-group">
                    <label>Empresa Construtora *</label>
                    <input type="text" id="empresaConstrutora" required>
                </div>
                
                <div class="form-group">
                    <label>Respons√°vel T√©cnico da Obra *</label>
                    <input type="text" id="responsavelTecnico" required>
                </div>
                
                <div class="form-group">
                    <label>Matr√≠cula CEI/CNPJ *</label>
                    <input type="text" id="matriculaCEI" required>
                </div>
                
                <div class="form-group">
                    <label>N√∫mero de Trabalhadores no Dia *</label>
                    <input type="number" id="numeroTrabalhadores" min="0" required>
                </div>
                
                <button class="btn btn-primary btn-block" onclick="iniciarVistoria()">
                    Iniciar Vistoria ‚Üí
                </button>
            </div>
        </div>
    </div>

    <!-- Screen 2: Checklist -->
    <div class="screen" id="screen-checklist">
        <div class="checklist-layout">
            <!-- Sidebar -->
            <div class="sidebar" id="sidebar">
                <!-- Will be populated by JavaScript -->
            </div>
            
            <!-- Main Content -->
            <div class="main-content" id="mainContent">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
        
        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <button class="btn btn-secondary" onclick="voltarInicio()">
                ‚Üê Voltar
            </button>
            <button class="btn btn-primary" onclick="finalizarVistoria()">
                Finalizar Vistoria
            </button>
        </div>
        
        <!-- Mobile Menu Toggle -->
        <button class="menu-toggle" onclick="toggleMobileMenu()" style="display: none;">
            ‚ò∞
        </button>
        
        <!-- Mobile Overlay -->
        <div class="mobile-overlay" onclick="toggleMobileMenu()"></div>
    </div>

    <!-- Screen 3: Report Summary -->
    <div class="screen" id="screen-report">
        <div class="container">
            <div class="form-card">
                <h2 style="margin-bottom: 20px; color: var(--primary-green);">Resumo da Vistoria</h2>

                <div class="report-summary" id="reportSummary">
                    <!-- Will be populated by JavaScript -->
                </div>

                <div class="form-group">
                    <label>Observa√ß√µes Finais</label>
                    <textarea id="observacoesFinais" rows="4" placeholder="Observa√ß√µes adicionais sobre a vistoria..."></textarea>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 25px;">
                    <button class="btn btn-secondary" onclick="voltarChecklist()">
                        ‚Üê Voltar ao Checklist
                    </button>
                    <button class="btn btn-primary" style="flex: 1;" onclick="gerarRelatorio()">
                        üìÑ Gerar o Relat√≥rio
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Screen 4: Report Preview -->
    <div class="screen" id="screen-report-preview">
        <div class="container">
            <div class="form-card">
                <h2 style="margin-bottom: 20px; color: var(--primary-green);">Relat√≥rio Gerado</h2>

                <div id="reportContent" style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <!-- Summary info will be shown here -->
                </div>

                <!-- PDF Preview Section -->
                <div style="margin-bottom: 20px;">
                    <h3 style="color: var(--primary-green); margin-bottom: 10px; font-size: 16px;">üìÑ Pr√©-visualiza√ß√£o do Relat√≥rio</h3>
                    <div style="border: 2px solid var(--border-gray); border-radius: 8px; overflow: hidden; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <iframe id="pdfPreview"></iframe>
                    </div>
                    <p style="font-size: 12px; color: #666; margin-top: 8px; text-align: center;">
                        üí° Dica: Use os controles do visualizador para navegar, ampliar e visualizar todo o relat√≥rio
                    </p>
                </div>

                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="voltarSummary()">
                        ‚Üê Voltar
                    </button>
                    <button class="btn btn-primary" style="flex: 1;" onclick="baixarPDF()">
                        üì• Baixar PDF
                    </button>
                    <button class="btn btn-primary" style="flex: 1;" onclick="compartilharPDF()">
                        üì§ Compartilhar PDF
                    </button>
                </div>

                <div style="margin-top: 15px; text-align: center;">
                    <button class="btn btn-secondary" onclick="novaVistoria()">
                        üîÑ Nova Vistoria
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal" id="loadingModal">
        <div class="modal-content" style="text-align: center;">
            <div class="spinner"></div>
            <h3 id="loadingText">Gerando relat√≥rio...</h3>
            <p style="color: #666; margin-top: 10px;">Por favor, aguarde</p>
        </div>
    </div>

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <script>
        // Global Variables
        let vistoriaData = {
            info: {},
            checklist: {},
            startTime: null,
            endTime: null
        };

        // Checklist Structure
        const checklistStructure = {
            "1": {
                title: "SERVI√áOS EM EXECU√á√ÉO",
                sections: {
                    "1.1": {
                        title: "Funda√ß√µes e Conten√ß√µes",
                        items: [
                            { text: "Escava√ß√µes protegidas adequadamente", type: "conform" },
                            { text: "Escoramento dimensionado e instalado", type: "conform" },
                            { text: "Sinaliza√ß√£o de √°reas de risco", type: "rating" },
                            { text: "Acesso seguro √†s escava√ß√µes", type: "conform" },
                            { text: "Drenagem adequada", type: "rating" }
                        ]
                    },
                    "1.2": {
                        title: "Estrutura (Concreto/Alvenaria)",
                        items: [
                            { text: "Prote√ß√£o de bordas de lajes", type: "conform" },
                            { text: "Telas de prote√ß√£o instaladas", type: "rating" },
                            { text: "Plataformas de trabalho adequadas", type: "conform" },
                            { text: "Escadas provis√≥rias em bom estado", type: "rating" },
                            { text: "V√£os e aberturas protegidos", type: "conform" },
                            { text: "Estoque de materiais organizado", type: "rating" }
                        ]
                    },
                    "1.3": {
                        title: "Trabalho em Altura (NR 35)",
                        items: [
                            { text: "Linha de vida instalada", type: "conform" },
                            { text: "Pontos de ancoragem certificados", type: "conform" },
                            { text: "Andaimes com guarda-corpo", type: "conform" },
                            { text: "Uso de trava-quedas", type: "conform" },
                            { text: "Sinaliza√ß√£o de √°rea isolada", type: "rating" }
                        ]
                    },
                    "1.4": {
                        title: "M√°quinas e Equipamentos",
                        items: [
                            { text: "Betoneira com prote√ß√£o", type: "conform" },
                            { text: "Serra circular com coifa", type: "conform" },
                            { text: "Equipamentos aterrados", type: "conform" },
                            { text: "Estado de conserva√ß√£o", type: "rating" },
                            { text: "Operadores habilitados", type: "conform" }
                        ]
                    },
                    "1.5": {
                        title: "Instala√ß√µes El√©tricas Provis√≥rias",
                        items: [
                            { text: "Quadros el√©tricos com DR", type: "conform" },
                            { text: "Fia√ß√£o protegida", type: "rating" },
                            { text: "Aterramento adequado", type: "conform" },
                            { text: "Identifica√ß√£o de circuitos", type: "conform" },
                            { text: "Ilumina√ß√£o adequada", type: "rating" }
                        ]
                    },
                    "1.6": {
                        title: "Elevador de Carga/Cremalheira",
                        items: [
                            { text: "Cabine fechada", type: "conform" },
                            { text: "Portas guilhotina funcionando", type: "conform" },
                            { text: "Manuten√ß√£o em dia (ART)", type: "conform" },
                            { text: "Operador treinado", type: "conform" },
                            { text: "Sinaliza√ß√£o de carga m√°xima", type: "conform" }
                        ]
                    }
                }
            },
            "2": {
                title: "√ÅREAS DE VIV√äNCIA (NR 18)",
                sections: {
                    "2.1": {
                        title: "Instala√ß√µes Sanit√°rias",
                        items: [
                            { text: "Quantidade adequada de vasos", type: "conform" },
                            { text: "Limpeza e higieniza√ß√£o", type: "rating" },
                            { text: "Chuveiros funcionando", type: "conform" },
                            { text: "Ventila√ß√£o adequada", type: "rating" },
                            { text: "Papel higi√™nico e sabonete", type: "conform" },
                            { text: "Coleta de lixo", type: "rating" }
                        ]
                    },
                    "2.2": {
                        title: "Vesti√°rios",
                        items: [
                            { text: "Arm√°rios individuais", type: "conform" },
                            { text: "Bancos em n√∫mero adequado", type: "conform" },
                            { text: "Limpeza e organiza√ß√£o", type: "rating" },
                            { text: "√Årea coberta", type: "conform" }
                        ]
                    },
                    "2.3": {
                        title: "Refeit√≥rio",
                        items: [
                            { text: "Mesas e bancos suficientes", type: "conform" },
                            { text: "Bebedouro/√°gua pot√°vel", type: "conform" },
                            { text: "Aquecedor de marmitas", type: "conform" },
                            { text: "Limpeza do ambiente", type: "rating" },
                            { text: "Prote√ß√£o contra intemp√©ries", type: "conform" },
                            { text: "Coleta seletiva de lixo", type: "rating" }
                        ]
                    },
                    "2.4": {
                        title: "Alojamento (se aplic√°vel)",
                        items: [
                            { text: "Camas/beliches adequados", type: "rating" },
                            { text: "√Årea m√≠nima por trabalhador", type: "conform" },
                            { text: "Ventila√ß√£o e ilumina√ß√£o", type: "rating" },
                            { text: "Roupas de cama limpas", type: "rating" }
                        ]
                    }
                }
            },
            "3": {
                title: "SEGURAN√áA DO TRABALHO - CAMPO",
                sections: {
                    "3.1": {
                        title: "EPIs (Equipamentos de Prote√ß√£o Individual)",
                        items: [
                            { text: "Capacetes em uso", type: "rating" },
                            { text: "Botinas de seguran√ßa", type: "rating" },
                            { text: "√ìculos de prote√ß√£o (quando necess√°rio)", type: "conform" },
                            { text: "Luvas adequadas √† atividade", type: "rating" },
                            { text: "Protetor auricular (quando necess√°rio)", type: "conform" },
                            { text: "M√°scaras/respiradores (quando necess√°rio)", type: "conform" },
                            { text: "Cinto de seguran√ßa tipo paraquedista (trabalho em altura)", type: "conform" },
                            { text: "Estado de conserva√ß√£o dos EPIs", type: "rating" },
                            { text: "CAs v√°lidos e leg√≠veis", type: "conform" }
                        ]
                    },
                    "3.2": {
                        title: "EPCs (Equipamentos de Prote√ß√£o Coletiva)",
                        items: [
                            { text: "Guarda-corpo e rodap√©", type: "conform" },
                            { text: "Telas de prote√ß√£o perif√©ricas", type: "rating" },
                            { text: "Plataformas de prote√ß√£o (bandejas)", type: "conform" },
                            { text: "Sinaliza√ß√£o de seguran√ßa", type: "rating" },
                            { text: "Fitas zebradas/cones", type: "rating" },
                            { text: "Extintores (quantidade e validade)", type: "conform" },
                            { text: "Tapumes e port√µes", type: "rating" }
                        ]
                    },
                    "3.3": {
                        title: "Sinaliza√ß√£o",
                        items: [
                            { text: "Placas de seguran√ßa vis√≠veis", type: "rating" },
                            { text: "Sinaliza√ß√£o de √°rea de risco", type: "conform" },
                            { text: "Identifica√ß√£o de sa√≠das de emerg√™ncia", type: "conform" },
                            { text: "Faixas de delimita√ß√£o", type: "rating" }
                        ]
                    },
                    "3.4": {
                        title: "Organiza√ß√£o e Limpeza (5S)",
                        items: [
                            { text: "Canteiro organizado", type: "rating" },
                            { text: "Materiais estocados adequadamente", type: "rating" },
                            { text: "Lixo segregado e acondicionado", type: "rating" },
                            { text: "Acessos desobstru√≠dos", type: "conform" },
                            { text: "Entulho recolhido", type: "rating" }
                        ]
                    },
                    "3.5": {
                        title: "Treinamentos e Capacita√ß√£o",
                        items: [
                            { text: "Trabalhadores com integra√ß√£o", type: "conform" },
                            { text: "DDS (Di√°logo Di√°rio de Seguran√ßa)", type: "conform" },
                            { text: "Treinamento NR 35 (trabalho em altura)", type: "conform" },
                            { text: "Treinamento NR 18 atualizado", type: "conform" },
                            { text: "Operadores com cursos v√°lidos", type: "conform" }
                        ]
                    }
                }
            },
            "4": {
                title: "SEGURAN√áA DO TRABALHO - DOCUMENTA√á√ÉO",
                sections: {
                    "4.1": {
                        title: "Documentos Obrigat√≥rios",
                        items: [
                            { text: "PCMAT dispon√≠vel e atualizado", type: "conform" },
                            { text: "PPRA/PGR dispon√≠vel", type: "conform" },
                            { text: "LTCAT (se aplic√°vel)", type: "conform" },
                            { text: "Alvar√° de constru√ß√£o", type: "conform" },
                            { text: "ART/TRT de seguran√ßa", type: "conform" },
                            { text: "Ordem de servi√ßo de seguran√ßa", type: "conform" }
                        ]
                    },
                    "4.2": {
                        title: "Registros de Treinamento",
                        items: [
                            { text: "Fichas de EPI assinadas", type: "conform" },
                            { text: "Listas de presen√ßa em treinamentos", type: "conform" },
                            { text: "Certificados de NR 35", type: "conform" },
                            { text: "Certificados de NR 18", type: "conform" },
                            { text: "Registro de DDS", type: "rating" }
                        ]
                    },
                    "4.3": {
                        title: "Laudos e Certificados",
                        items: [
                            { text: "Laudo de instala√ß√µes el√©tricas", type: "conform" },
                            { text: "ART de andaimes", type: "conform" },
                            { text: "ART de cremalheira/elevador", type: "conform" },
                            { text: "Certificados de EPIs (CAs)", type: "conform" },
                            { text: "Manuten√ß√µes de equipamentos em dia", type: "conform" }
                        ]
                    },
                    "4.4": {
                        title: "Organiza√ß√£o Documental",
                        items: [
                            { text: "Documentos organizados e acess√≠veis", type: "rating" },
                            { text: "Respons√°vel t√©cnico identificado", type: "conform" },
                            { text: "Atualiza√ß√µes peri√≥dicas realizadas", type: "rating" }
                        ]
                    }
                }
            },
            "5": {
                title: "OUTROS",
                sections: {
                    "5.1": {
                        title: "Meio Ambiente",
                        items: [
                            { text: "Controle de poeira", type: "rating" },
                            { text: "Controle de ru√≠do", type: "rating" },
                            { text: "Gest√£o de res√≠duos", type: "rating" },
                            { text: "Armazenamento de produtos qu√≠micos", type: "conform" },
                            { text: "Prote√ß√£o de √°reas verdes (se aplic√°vel)", type: "conform" }
                        ]
                    },
                    "5.2": {
                        title: "Vizinhan√ßa e Log√≠stica",
                        items: [
                            { text: "Impacto na vizinhan√ßa controlado", type: "rating" },
                            { text: "Hor√°rios de trabalho respeitados", type: "conform" },
                            { text: "Acesso de ve√≠culos controlado", type: "rating" },
                            { text: "Sinaliza√ß√£o externa adequada", type: "rating" }
                        ]
                    },
                    "5.3": {
                        title: "Gest√£o de Pessoas",
                        items: [
                            { text: "Presen√ßa de t√©cnico de seguran√ßa", type: "conform" },
                            { text: "Equipe dimensionada adequadamente", type: "rating" },
                            { text: "Comunica√ß√£o efetiva", type: "rating" }
                        ]
                    }
                }
            },
            "6": {
                title: "BONIFICA√á√ïES/PENALIDADES",
                sections: {
                    "6.1": {
                        title: "Pontos Positivos (Bonifica√ß√µes)",
                        items: [
                            { text: "Inova√ß√µes em seguran√ßa implementadas", type: "description" },
                            { text: "Canteiro modelo/refer√™ncia", type: "description" },
                            { text: "Zero acidentes no per√≠odo", type: "description" },
                            { text: "Iniciativas de conscientiza√ß√£o", type: "description" },
                            { text: "Uso de tecnologia para seguran√ßa", type: "description" },
                            { text: "Cultura de seguran√ßa evidente", type: "description" }
                        ]
                    },
                    "6.2": {
                        title: "N√£o Conformidades Cr√≠ticas (Penalidades)",
                        items: [
                            { text: "Trabalho em altura sem prote√ß√£o - INTERDITAR", type: "critical" },
                            { text: "Instala√ß√£o el√©trica irregular - ATEN√á√ÉO", type: "critical" },
                            { text: "Aus√™ncia de EPIs obrigat√≥rios - ADVERT√äNCIA", type: "critical" },
                            { text: "Equipamentos sem manuten√ß√£o - ATEN√á√ÉO", type: "critical" },
                            { text: "PCMAT desatualizado/ausente - CR√çTICO", type: "critical" },
                            { text: "√Årea de risco sem isolamento - INTERDITAR", type: "critical" },
                            { text: "Reincid√™ncia de n√£o conformidades - PENALIDADE", type: "critical" }
                        ]
                    }
                }
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
        });

        function initializeApp() {
            // Set current date and time
            const now = new Date();
            document.getElementById('dataVisita').value = formatDate(now);
            document.getElementById('horaInicio').value = formatTime(now);
            
            // Check mobile
            if (window.innerWidth <= 768) {
                document.querySelector('.menu-toggle').style.display = 'flex';
            }
            
            // Initialize checklist data structure
            initializeChecklistData();
        }

        function initializeChecklistData() {
            for (let groupKey in checklistStructure) {
                const group = checklistStructure[groupKey];
                for (let sectionKey in group.sections) {
                    const section = group.sections[sectionKey];
                    section.items.forEach((item, index) => {
                        const itemId = `${groupKey}.${sectionKey}.${index}`;
                        vistoriaData.checklist[itemId] = {
                            text: item.text,
                            type: item.type,
                            checked: false,
                            evaluation: null,
                            observation: '',
                            photos: []
                        };
                    });
                }
            }
        }

        function formatDate(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function formatTime(date) {
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        function iniciarVistoria() {
            // Validate form
            const requiredFields = [
                'nomeEmpreendimento', 'numeroVisita', 'engenheiroVistoriador',
                'empresaConstrutora', 'responsavelTecnico', 'matriculaCEI', 'numeroTrabalhadores'
            ];
            
            for (let field of requiredFields) {
                const input = document.getElementById(field);
                if (!input.value.trim()) {
                    alert('Por favor, preencha todos os campos obrigat√≥rios!');
                    input.focus();
                    return;
                }
            }
            
            // Save initial data
            vistoriaData.info = {
                nomeEmpreendimento: document.getElementById('nomeEmpreendimento').value,
                numeroVisita: document.getElementById('numeroVisita').value,
                dataVisita: document.getElementById('dataVisita').value,
                horaInicio: document.getElementById('horaInicio').value,
                engenheiroVistoriador: document.getElementById('engenheiroVistoriador').value,
                engenheiroAcompanhante: document.getElementById('engenheiroAcompanhante').value,
                empresaConstrutora: document.getElementById('empresaConstrutora').value,
                responsavelTecnico: document.getElementById('responsavelTecnico').value,
                matriculaCEI: document.getElementById('matriculaCEI').value,
                numeroTrabalhadores: document.getElementById('numeroTrabalhadores').value
            };
            
            vistoriaData.startTime = new Date();
            
            // Build checklist interface
            buildChecklistInterface();
            
            // Switch to checklist screen
            switchScreen('screen-checklist');
        }

        function buildChecklistInterface() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            
            sidebar.innerHTML = '';
            mainContent.innerHTML = '';
            
            // Build sidebar
            for (let groupKey in checklistStructure) {
                const group = checklistStructure[groupKey];
                const sidebarItem = document.createElement('div');
                sidebarItem.className = 'sidebar-item';
                sidebarItem.dataset.group = groupKey;
                
                const itemCount = Object.values(group.sections).reduce((sum, section) => sum + section.items.length, 0);
                
                sidebarItem.innerHTML = `
                    <div class="sidebar-item-title">${groupKey}. ${group.title}</div>
                    <div class="sidebar-item-count">0 / ${itemCount} itens</div>
                    <div class="sidebar-item-progress">
                        <div class="sidebar-item-progress-bar" style="width: 0%"></div>
                    </div>
                `;
                
                sidebarItem.onclick = () => showGroup(groupKey);
                sidebar.appendChild(sidebarItem);
            }
            
            // Show first group
            showGroup('1');
        }

        function showGroup(groupKey) {
            // Update sidebar
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-group="${groupKey}"]`).classList.add('active');
            
            // Build main content
            const group = checklistStructure[groupKey];
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = '';
            
            // Section header
            const header = document.createElement('div');
            header.className = 'section-header';
            header.innerHTML = `
                <div class="section-title">${groupKey}. ${group.title}</div>
                <div class="section-subtitle">Preencha todos os itens desta se√ß√£o</div>
            `;
            mainContent.appendChild(header);
            
            // Progress
            const progress = createProgressBar(groupKey);
            mainContent.appendChild(progress);
            
            // Sections
            for (let sectionKey in group.sections) {
                const section = group.sections[sectionKey];
                
                const sectionHeader = document.createElement('div');
                sectionHeader.style.cssText = 'margin: 25px 0 15px 0; font-size: 18px; font-weight: 700; color: var(--primary-green);';
                sectionHeader.textContent = `${sectionKey} ${section.title}`;
                mainContent.appendChild(sectionHeader);
                
                section.items.forEach((item, index) => {
                    const itemId = `${groupKey}.${sectionKey}.${index}`;
                    const card = createChecklistCard(itemId, item);
                    mainContent.appendChild(card);
                });
            }
        }

        function createProgressBar(groupKey) {
            const container = document.createElement('div');
            container.className = 'progress-container';
            container.id = `progress-${groupKey}`;
            
            const group = checklistStructure[groupKey];
            const totalItems = Object.values(group.sections).reduce((sum, section) => sum + section.items.length, 0);
            
            container.innerHTML = `
                <div class="progress-text">
                    <span>Progresso</span>
                    <span><strong class="progress-count">0</strong> / ${totalItems}</span>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar" style="width: 0%"></div>
                </div>
            `;
            
            return container;
        }

        function createChecklistCard(itemId, item) {
            const card = document.createElement('div');
            card.className = 'checklist-card';
            card.id = `card-${itemId}`;
            
            const data = vistoriaData.checklist[itemId];
            
            let evaluationButtons = '';
            if (item.type === 'conform') {
                evaluationButtons = `
                    <div class="evaluation-buttons">
                        <button class="eval-btn conforme ${data.evaluation === 'Conforme' ? 'active' : ''}" onclick="setEvaluation('${itemId}', 'Conforme')">‚úì Conforme</button>
                        <button class="eval-btn nc ${data.evaluation === 'NC' ? 'active' : ''}" onclick="setEvaluation('${itemId}', 'NC')">‚úó NC</button>
                    </div>
                `;
            } else if (item.type === 'rating') {
                evaluationButtons = `
                    <div class="evaluation-buttons">
                        <button class="eval-btn ${data.evaluation === 'MB' ? 'active' : ''}" onclick="setEvaluation('${itemId}', 'MB')">MB</button>
                        <button class="eval-btn ${data.evaluation === 'B' ? 'active' : ''}" onclick="setEvaluation('${itemId}', 'B')">B</button>
                        <button class="eval-btn ${data.evaluation === 'OK' ? 'active' : ''}" onclick="setEvaluation('${itemId}', 'OK')">OK</button>
                        <button class="eval-btn ${data.evaluation === 'R' ? 'active' : ''}" onclick="setEvaluation('${itemId}', 'R')">R</button>
                        <button class="eval-btn ${data.evaluation === 'MR' ? 'active' : ''}" onclick="setEvaluation('${itemId}', 'MR')">MR</button>
                    </div>
                `;
            }
            
            card.innerHTML = `
                <div class="checklist-item-header">
                    <div class="checkbox-container">
                        <input type="checkbox" ${data.checked ? 'checked' : ''} onchange="toggleCheck('${itemId}')">
                    </div>
                    <div class="checklist-item-text">
                        <strong>${item.text}</strong>
                    </div>
                </div>
                
                ${evaluationButtons}
                
                <div class="observation-area">
                    <textarea placeholder="Observa√ß√µes..." onchange="setObservation('${itemId}', this.value)">${data.observation}</textarea>
                </div>
                
                <div class="photo-section">
                    <input type="file" accept="image/*" capture="environment" class="file-input-hidden" id="file-${itemId}" onchange="addPhoto('${itemId}', this)">
                    <button class="btn-photo" onclick="document.getElementById('file-${itemId}').click()">
                        üì∑ Adicionar Foto
                    </button>
                    <div class="photo-preview" id="photos-${itemId}">
                        ${data.photos.map((photo, i) => `
                            <div class="photo-item">
                                <img src="${photo}" alt="Foto">
                                <button class="photo-delete" onclick="removePhoto('${itemId}', ${i})">√ó</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            if (data.checked) {
                card.classList.add('checked');
            }
            if (data.evaluation === 'NC' || data.evaluation === 'MR') {
                card.classList.add('non-compliant');
            }
            
            return card;
        }

        function toggleCheck(itemId) {
            const data = vistoriaData.checklist[itemId];
            data.checked = !data.checked;
            
            const card = document.getElementById(`card-${itemId}`);
            if (data.checked) {
                card.classList.add('checked');
            } else {
                card.classList.remove('checked');
            }
            
            updateProgress();
        }

        function setEvaluation(itemId, value) {
            const data = vistoriaData.checklist[itemId];
            data.evaluation = value;
            data.checked = true;
            
            // Update UI
            const card = document.getElementById(`card-${itemId}`);
            card.classList.add('checked');
            
            // Update buttons
            card.querySelectorAll('.eval-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Mark as non-compliant if needed
            if (value === 'NC' || value === 'MR') {
                card.classList.add('non-compliant');
            } else {
                card.classList.remove('non-compliant');
            }
            
            // Update checkbox
            card.querySelector('input[type="checkbox"]').checked = true;
            
            updateProgress();
        }

        function setObservation(itemId, value) {
            vistoriaData.checklist[itemId].observation = value;
        }

        function addPhoto(itemId, input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = vistoriaData.checklist[itemId];
                data.photos.push(e.target.result);
                
                // Update photo preview
                const photoPreview = document.getElementById(`photos-${itemId}`);
                const photoIndex = data.photos.length - 1;
                
                const photoItem = document.createElement('div');
                photoItem.className = 'photo-item';
                photoItem.innerHTML = `
                    <img src="${e.target.result}" alt="Foto">
                    <button class="photo-delete" onclick="removePhoto('${itemId}', ${photoIndex})">√ó</button>
                `;
                
                photoPreview.appendChild(photoItem);
                
                // Clear input
                input.value = '';
            };
            reader.readAsDataURL(file);
        }

        function removePhoto(itemId, photoIndex) {
            const data = vistoriaData.checklist[itemId];
            data.photos.splice(photoIndex, 1);
            
            // Rebuild photo preview
            const photoPreview = document.getElementById(`photos-${itemId}`);
            photoPreview.innerHTML = data.photos.map((photo, i) => `
                <div class="photo-item">
                    <img src="${photo}" alt="Foto">
                    <button class="photo-delete" onclick="removePhoto('${itemId}', ${i})">√ó</button>
                </div>
            `).join('');
        }

        function updateProgress() {
            // Update each group's progress
            for (let groupKey in checklistStructure) {
                const group = checklistStructure[groupKey];
                let totalItems = 0;
                let checkedItems = 0;
                
                for (let sectionKey in group.sections) {
                    const section = group.sections[sectionKey];
                    section.items.forEach((item, index) => {
                        const itemId = `${groupKey}.${sectionKey}.${index}`;
                        totalItems++;
                        if (vistoriaData.checklist[itemId].checked) {
                            checkedItems++;
                        }
                    });
                }
                
                const percentage = totalItems > 0 ? (checkedItems / totalItems * 100) : 0;
                
                // Update sidebar
                const sidebarItem = document.querySelector(`[data-group="${groupKey}"]`);
                if (sidebarItem) {
                    sidebarItem.querySelector('.sidebar-item-count').textContent = `${checkedItems} / ${totalItems} itens`;
                    sidebarItem.querySelector('.sidebar-item-progress-bar').style.width = `${percentage}%`;
                }
                
                // Update progress bar in main content
                const progressBar = document.getElementById(`progress-${groupKey}`);
                if (progressBar) {
                    progressBar.querySelector('.progress-count').textContent = checkedItems;
                    progressBar.querySelector('.progress-bar').style.width = `${percentage}%`;
                }
            }
        }

        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('active');
        }

        function voltarInicio() {
            if (confirm('Tem certeza que deseja voltar? Os dados n√£o ser√£o perdidos.')) {
                switchScreen('screen-initial');
            }
        }

        function voltarChecklist() {
            switchScreen('screen-checklist');
        }

        function finalizarVistoria() {
            vistoriaData.endTime = new Date();
            
            // Generate summary
            generateSummary();
            
            switchScreen('screen-report');
        }

        function generateSummary() {
            const summary = {
                total: 0,
                checked: 0,
                conforme: 0,
                naoConforme: 0,
                critical: [],
                byGroup: {}
            };
            
            for (let itemId in vistoriaData.checklist) {
                const data = vistoriaData.checklist[itemId];
                summary.total++;
                
                if (data.checked) {
                    summary.checked++;
                }
                
                if (data.evaluation === 'Conforme' || ['MB', 'B', 'OK'].includes(data.evaluation)) {
                    summary.conforme++;
                } else if (data.evaluation === 'NC' || data.evaluation === 'MR') {
                    summary.naoConforme++;
                    
                    // Check if critical
                    if (data.text.includes('INTERDITAR') || data.text.includes('CR√çTICO')) {
                        summary.critical.push({
                            item: data.text,
                            observation: data.observation,
                            photos: data.photos
                        });
                    }
                }
                
                // By group
                const groupKey = itemId.split('.')[0];
                if (!summary.byGroup[groupKey]) {
                    summary.byGroup[groupKey] = { total: 0, checked: 0, conforme: 0 };
                }
                summary.byGroup[groupKey].total++;
                if (data.checked) summary.byGroup[groupKey].checked++;
                if (data.evaluation === 'Conforme' || ['MB', 'B', 'OK'].includes(data.evaluation)) {
                    summary.byGroup[groupKey].conforme++;
                }
            }
            
            // Display summary
            const summaryDiv = document.getElementById('reportSummary');
            const conformityPercentage = summary.checked > 0 ? ((summary.conforme / summary.checked) * 100).toFixed(1) : 0;
            
            let criticalHTML = '';
            if (summary.critical.length > 0) {
                criticalHTML = `
                    <div class="critical-issues">
                        <h3>‚ö†Ô∏è N√£o Conformidades Cr√≠ticas (${summary.critical.length})</h3>
                        ${summary.critical.map(item => `
                            <div class="critical-item">
                                <strong>${item.item}</strong>
                                ${item.observation ? `<p style="margin-top: 8px;">${item.observation}</p>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            summaryDiv.innerHTML = `
                <h3 style="margin-bottom: 15px;">Resumo da Vistoria</h3>
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="summary-card-value">${summary.checked}</div>
                        <div class="summary-card-label">Itens Verificados</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-card-value success-value">${summary.conforme}</div>
                        <div class="summary-card-label">Conformes</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-card-value danger-value">${summary.naoConforme}</div>
                        <div class="summary-card-label">N√£o Conformes</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-card-value ${conformityPercentage >= 80 ? 'success-value' : conformityPercentage >= 60 ? 'warning-value' : 'danger-value'}">${conformityPercentage}%</div>
                        <div class="summary-card-label">Conformidade</div>
                    </div>
                </div>
                ${criticalHTML}
            `;
            
            vistoriaData.summary = summary;
        }

        let generatedPdfBlob = null;

        async function gerarRelatorio() {
            const observacoesFinais = document.getElementById('observacoesFinais').value;
            vistoriaData.observacoesFinais = observacoesFinais;

            showLoading('Gerando relat√≥rio PDF...');

            // Generate PDF
            setTimeout(async () => {
                try {
                    await generatePDF();
                    hideLoading();
                    switchScreen('screen-report-preview');
                } catch (error) {
                    hideLoading();
                    alert('Erro ao gerar relat√≥rio: ' + error.message);
                }
            }, 500);
        }

        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');

            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const margin = 15;
            let yPos = 20;

            // Header
            pdf.setFillColor(1, 58, 15);
            pdf.rect(0, 0, pageWidth, 40, 'F');

            // Add logo
            try {
                const logoImg = document.querySelector('.header-logo');
                if (logoImg) {
                    // Esperar a imagem carregar se necess√°rio
                    if (!logoImg.complete) {
                        await new Promise(resolve => {
                            logoImg.onload = resolve;
                            logoImg.onerror = resolve;
                        });
                    }

                    if (logoImg.complete && logoImg.naturalHeight !== 0) {
                        // Converter imagem para base64 usando canvas
                        const canvas = document.createElement('canvas');
                        canvas.width = logoImg.naturalWidth;
                        canvas.height = logoImg.naturalHeight;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(logoImg, 0, 0);
                        const imgData = canvas.toDataURL('image/jpeg', 1.0);

                        // Adicionar imagem ao PDF
                        pdf.addImage(imgData, 'JPEG', margin, 8, 25, 25);
                    }
                }
            } catch (error) {
                console.error('Erro ao adicionar logo:', error);
            }

            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(20);
            pdf.setFont(undefined, 'bold');
            pdf.text('AM ENGENHARIA', margin + 30, 15);

            pdf.setFontSize(12);
            pdf.setFont(undefined, 'normal');
            pdf.text('Relat√≥rio de Vistoria de Seguran√ßa do Trabalho', margin + 30, 25);

            yPos = 50;
            pdf.setTextColor(0, 0, 0);

            // Informa√ß√µes da Vistoria
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text('INFORMA√á√ïES DA VISTORIA', margin, yPos);
            yPos += 10;

            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            const info = vistoriaData.info;

            pdf.text(`Empreendimento: ${info.nomeEmpreendimento}`, margin, yPos);
            yPos += 6;
            pdf.text(`Visita N¬∫: ${info.numeroVisita}`, margin, yPos);
            pdf.text(`Data: ${info.dataVisita}`, margin + 80, yPos);
            yPos += 6;
            pdf.text(`Hora In√≠cio: ${info.horaInicio}`, margin, yPos);
            if (vistoriaData.endTime) {
                pdf.text(`Hora T√©rmino: ${formatTime(vistoriaData.endTime)}`, margin + 80, yPos);
            }
            yPos += 6;
            pdf.text(`Engenheiro Vistoriador: ${info.engenheiroVistoriador}`, margin, yPos);
            yPos += 6;
            if (info.engenheiroAcompanhante) {
                pdf.text(`Engenheiro Acompanhante: ${info.engenheiroAcompanhante}`, margin, yPos);
                yPos += 6;
            }
            pdf.text(`Empresa Construtora: ${info.empresaConstrutora}`, margin, yPos);
            yPos += 6;
            pdf.text(`Respons√°vel T√©cnico: ${info.responsavelTecnico}`, margin, yPos);
            yPos += 6;
            pdf.text(`Matr√≠cula CEI/CNPJ: ${info.matriculaCEI}`, margin, yPos);
            yPos += 6;
            pdf.text(`Trabalhadores no Dia: ${info.numeroTrabalhadores}`, margin, yPos);
            yPos += 10;

            // Resumo
            const summary = vistoriaData.summary;
            const conformityPercentage = summary.checked > 0 ? ((summary.conforme / summary.checked) * 100).toFixed(1) : 0;

            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text('RESUMO DA VISTORIA', margin, yPos);
            yPos += 10;

            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            pdf.text(`Total de Itens Verificados: ${summary.checked}`, margin, yPos);
            yPos += 6;

            pdf.setTextColor(2, 120, 30);
            pdf.text(`Conformes: ${summary.conforme}`, margin, yPos);
            pdf.setTextColor(0, 0, 0);

            pdf.setTextColor(220, 53, 69);
            pdf.text(`N√£o Conformes: ${summary.naoConforme}`, margin + 80, yPos);
            pdf.setTextColor(0, 0, 0);
            yPos += 6;

            const conformityColor = conformityPercentage >= 80 ? [2, 120, 30] : conformityPercentage >= 60 ? [255, 140, 0] : [220, 53, 69];
            pdf.setTextColor(...conformityColor);
            pdf.setFont(undefined, 'bold');
            pdf.text(`Taxa de Conformidade: ${conformityPercentage}%`, margin, yPos);
            pdf.setTextColor(0, 0, 0);
            pdf.setFont(undefined, 'normal');
            yPos += 10;

            // N√£o Conformidades Cr√≠ticas
            if (summary.critical.length > 0) {
                if (yPos > pageHeight - 60) {
                    pdf.addPage();
                    yPos = 20;
                }

                pdf.setFillColor(255, 245, 245);
                pdf.rect(margin - 5, yPos - 5, pageWidth - 2 * margin + 10, 10, 'F');

                pdf.setTextColor(220, 53, 69);
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'bold');
                pdf.text(`‚ö† N√ÉO CONFORMIDADES CR√çTICAS (${summary.critical.length})`, margin, yPos);
                pdf.setTextColor(0, 0, 0);
                yPos += 8;

                pdf.setFontSize(9);
                pdf.setFont(undefined, 'normal');
                summary.critical.forEach((item, index) => {
                    if (yPos > pageHeight - 30) {
                        pdf.addPage();
                        yPos = 20;
                    }

                    pdf.setFont(undefined, 'bold');
                    const lines = pdf.splitTextToSize(`${index + 1}. ${item.item}`, pageWidth - 2 * margin);
                    pdf.text(lines, margin, yPos);
                    yPos += lines.length * 5;

                    if (item.observation) {
                        pdf.setFont(undefined, 'normal');
                        const obsLines = pdf.splitTextToSize(`Obs: ${item.observation}`, pageWidth - 2 * margin - 5);
                        pdf.text(obsLines, margin + 5, yPos);
                        yPos += obsLines.length * 5;
                    }
                    yPos += 3;
                });
                yPos += 5;
            }

            // Observa√ß√µes Finais
            if (vistoriaData.observacoesFinais) {
                if (yPos > pageHeight - 40) {
                    pdf.addPage();
                    yPos = 20;
                }

                pdf.setFontSize(12);
                pdf.setFont(undefined, 'bold');
                pdf.text('OBSERVA√á√ïES FINAIS', margin, yPos);
                yPos += 8;

                pdf.setFontSize(10);
                pdf.setFont(undefined, 'normal');
                const obsLines = pdf.splitTextToSize(vistoriaData.observacoesFinais, pageWidth - 2 * margin);
                pdf.text(obsLines, margin, yPos);
                yPos += obsLines.length * 5 + 10;
            }

            // Detalhamento Completo dos Itens Verificados (nova p√°gina)
            pdf.addPage();
            yPos = 20;

            pdf.setFontSize(16);
            pdf.setFont(undefined, 'bold');
            pdf.text('DETALHAMENTO DOS ITENS VERIFICADOS', margin, yPos);
            yPos += 12;

            // Contadores para numera√ß√£o sequencial
            let groupCounter = 0;

            // Iterar por cada grupo
            for (let groupKey in checklistStructure) {
                const group = checklistStructure[groupKey];

                // Verificar se o grupo tem algum item verificado
                let groupHasCheckedItems = false;
                for (let sectionKey in group.sections) {
                    const section = group.sections[sectionKey];
                    for (let index = 0; index < section.items.length; index++) {
                        const itemId = `${groupKey}.${sectionKey}.${index}`;
                        if (vistoriaData.checklist[itemId].checked) {
                            groupHasCheckedItems = true;
                            break;
                        }
                    }
                    if (groupHasCheckedItems) break;
                }

                // S√≥ mostrar o grupo se tiver itens verificados
                if (!groupHasCheckedItems) continue;

                // Incrementar contador do grupo
                groupCounter++;

                // Verificar se h√° espa√ßo suficiente para o t√≠tulo do grupo
                if (yPos > pageHeight - 40) {
                    pdf.addPage();
                    yPos = 20;
                }

                // T√≠tulo do Grupo (com numera√ß√£o sequencial)
                pdf.setFillColor(1, 58, 15);
                pdf.rect(margin - 5, yPos - 6, pageWidth - 2 * margin + 10, 10, 'F');
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'bold');
                pdf.text(`${groupCounter}. ${group.title}`, margin, yPos);
                pdf.setTextColor(0, 0, 0);
                yPos += 12;

                // Contador para se√ß√µes dentro do grupo
                let sectionCounter = 0;

                // Iterar por cada se√ß√£o
                for (let sectionKey in group.sections) {
                    const section = group.sections[sectionKey];

                    // Verificar se a se√ß√£o tem algum item verificado
                    let sectionHasCheckedItems = false;
                    for (let index = 0; index < section.items.length; index++) {
                        const itemId = `${groupKey}.${sectionKey}.${index}`;
                        if (vistoriaData.checklist[itemId].checked) {
                            sectionHasCheckedItems = true;
                            break;
                        }
                    }

                    // S√≥ mostrar a se√ß√£o se tiver itens verificados
                    if (!sectionHasCheckedItems) continue;

                    // Incrementar contador da se√ß√£o
                    sectionCounter++;

                    // Verificar se h√° espa√ßo para o t√≠tulo da se√ß√£o
                    if (yPos > pageHeight - 30) {
                        pdf.addPage();
                        yPos = 20;
                    }

                    // T√≠tulo da Se√ß√£o (com numera√ß√£o sequencial)
                    pdf.setFontSize(11);
                    pdf.setFont(undefined, 'bold');
                    pdf.setTextColor(2, 120, 30);
                    pdf.text(`${groupCounter}.${sectionCounter} ${section.title}`, margin, yPos);
                    pdf.setTextColor(0, 0, 0);
                    yPos += 8;

                    // Iterar por cada item
                    section.items.forEach((item, index) => {
                        const itemId = `${groupKey}.${sectionKey}.${index}`;
                        const itemData = vistoriaData.checklist[itemId];

                        // S√≥ incluir itens que foram verificados
                        if (itemData.checked) {
                            // Verificar espa√ßo dispon√≠vel
                            if (yPos > pageHeight - 40) {
                                pdf.addPage();
                                yPos = 20;
                            }

                            // Desenhar borda do item
                            const itemStartY = yPos - 3;
                            pdf.setDrawColor(220, 220, 220);
                            pdf.setLineWidth(0.5);

                            // Texto do Item
                            pdf.setFontSize(9);
                            pdf.setFont(undefined, 'bold');
                            const itemLines = pdf.splitTextToSize(`‚Ä¢ ${itemData.text}`, pageWidth - 2 * margin - 10);
                            pdf.text(itemLines, margin + 3, yPos);
                            yPos += itemLines.length * 4.5;

                            // Avalia√ß√£o
                            if (itemData.evaluation) {
                                pdf.setFont(undefined, 'normal');
                                let evalText = `Avalia√ß√£o: ${itemData.evaluation}`;
                                let evalColor = [0, 0, 0];

                                // Definir cor baseada na avalia√ß√£o
                                if (itemData.evaluation === 'Conforme' || ['MB', 'B', 'OK'].includes(itemData.evaluation)) {
                                    evalColor = [2, 120, 30];
                                    evalText += ' ‚úì';
                                } else if (itemData.evaluation === 'NC' || ['R', 'MR'].includes(itemData.evaluation)) {
                                    evalColor = [220, 53, 69];
                                    evalText += ' ‚úó';
                                }

                                pdf.setTextColor(...evalColor);
                                pdf.text(evalText, margin + 3, yPos);
                                pdf.setTextColor(0, 0, 0);
                                yPos += 5;
                            }

                            // Observa√ß√£o
                            if (itemData.observation && itemData.observation.trim()) {
                                pdf.setFont(undefined, 'italic');
                                pdf.setFontSize(8);
                                const obsLines = pdf.splitTextToSize(`Obs: ${itemData.observation}`, pageWidth - 2 * margin - 10);
                                pdf.text(obsLines, margin + 3, yPos);
                                yPos += obsLines.length * 4;
                                pdf.setFontSize(9);
                                pdf.setFont(undefined, 'normal');
                            }

                            // Fotos
                            if (itemData.photos && itemData.photos.length > 0) {
                                yPos += 2;
                                pdf.setFontSize(8);
                                pdf.text(`Fotos anexadas: ${itemData.photos.length}`, margin + 3, yPos);
                                yPos += 5;

                                // Adicionar miniaturas das fotos (opcional, pode aumentar muito o tamanho do PDF)
                                for (let i = 0; i < Math.min(itemData.photos.length, 2); i++) {
                                    if (yPos > pageHeight - 50) {
                                        pdf.addPage();
                                        yPos = 20;
                                    }

                                    try {
                                        const photo = itemData.photos[i];
                                        const imgWidth = 40;
                                        const imgHeight = 30;
                                        pdf.addImage(photo, 'JPEG', margin + 3 + (i * 45), yPos, imgWidth, imgHeight);
                                    } catch (error) {
                                        console.error('Erro ao adicionar foto:', error);
                                    }
                                }

                                if (itemData.photos.length > 0) {
                                    yPos += 32;
                                }
                            }

                            // Desenhar borda do item
                            const itemHeight = yPos - itemStartY + 2;
                            pdf.rect(margin, itemStartY, pageWidth - 2 * margin, itemHeight);

                            yPos += 5;
                        }
                    });

                    yPos += 3;
                }

                yPos += 5;
            }

            // Footer
            const pageCount = pdf.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                pdf.setPage(i);
                pdf.setFontSize(8);
                pdf.setTextColor(128, 128, 128);
                pdf.text(`Gerado em ${formatDate(new Date())} √†s ${formatTime(new Date())}`, margin, pageHeight - 10);
                pdf.text(`P√°gina ${i} de ${pageCount}`, pageWidth - margin - 20, pageHeight - 10);
            }

            // Generate blob and preview
            generatedPdfBlob = pdf.output('blob');

            // Create blob URL for PDF preview
            const pdfUrl = URL.createObjectURL(generatedPdfBlob);

            // Display summary info
            const reportContent = document.getElementById('reportContent');
            reportContent.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 48px; margin-bottom: 15px;">‚úÖ</div>
                    <h3 style="color: var(--primary-green); margin-bottom: 10px;">Relat√≥rio PDF Gerado com Sucesso!</h3>
                    <p style="color: #666; margin-bottom: 20px;">
                        <strong>Empreendimento:</strong> ${info.nomeEmpreendimento}<br>
                        <strong>Data:</strong> ${info.dataVisita}<br>
                        <strong>Taxa de Conformidade:</strong> <span style="color: ${conformityPercentage >= 80 ? 'var(--success-green)' : conformityPercentage >= 60 ? 'var(--warning-orange)' : 'var(--danger-red)'}; font-weight: bold;">${conformityPercentage}%</span>
                    </p>
                    <div style="background: var(--bg-gray); padding: 15px; border-radius: 8px; margin-top: 20px;">
                        <p style="margin: 0; color: #666;">
                            ‚úì ${summary.checked} itens verificados<br>
                            ‚úì ${summary.conforme} conformes<br>
                            ${summary.naoConforme > 0 ? `‚úó ${summary.naoConforme} n√£o conformes` : ''}
                            ${summary.critical.length > 0 ? `<br>‚ö† ${summary.critical.length} n√£o conformidades cr√≠ticas` : ''}
                        </p>
                    </div>
                </div>
            `;

            // Load PDF in iframe preview
            const pdfPreview = document.getElementById('pdfPreview');
            pdfPreview.src = pdfUrl;

            // Store URL for cleanup later
            window.currentPdfUrl = pdfUrl;
        }

        function voltarSummary() {
            // Clean up blob URL
            if (window.currentPdfUrl) {
                URL.revokeObjectURL(window.currentPdfUrl);
                window.currentPdfUrl = null;
            }
            switchScreen('screen-report');
        }

        async function baixarPDF() {
            if (!generatedPdfBlob) {
                alert('Nenhum relat√≥rio foi gerado ainda.');
                return;
            }

            const fileName = `Vistoria_${vistoriaData.info.nomeEmpreendimento.replace(/\s+/g, '_')}_${vistoriaData.info.dataVisita.replace(/\//g, '-')}.pdf`;

            // Create download link
            const url = URL.createObjectURL(generatedPdfBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert('Download do PDF iniciado!');
        }

        async function compartilharPDF() {
            if (!generatedPdfBlob) {
                alert('Nenhum relat√≥rio foi gerado ainda.');
                return;
            }

            const fileName = `Vistoria_${vistoriaData.info.nomeEmpreendimento.replace(/\s+/g, '_')}_${vistoriaData.info.dataVisita.replace(/\//g, '-')}.pdf`;

            // Check if Web Share API is available
            if (navigator.share) {
                try {
                    const file = new File([generatedPdfBlob], fileName, { type: 'application/pdf' });
                    await navigator.share({
                        title: 'Relat√≥rio de Vistoria',
                        text: `Relat√≥rio de Vistoria - ${vistoriaData.info.nomeEmpreendimento}`,
                        files: [file]
                    });
                    alert('Relat√≥rio compartilhado com sucesso!');
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        alert('Erro ao compartilhar: ' + error.message);
                    }
                }
            } else {
                // Fallback: download the file
                alert('Compartilhamento n√£o dispon√≠vel neste dispositivo. O arquivo ser√° baixado.');
                baixarPDF();
            }
        }

        function novaVistoria() {
            if (confirm('Deseja iniciar uma nova vistoria? Todos os dados atuais ser√£o perdidos.')) {
                // Clean up blob URL
                if (window.currentPdfUrl) {
                    URL.revokeObjectURL(window.currentPdfUrl);
                    window.currentPdfUrl = null;
                }
                resetApp();
                switchScreen('screen-initial');
            }
        }

        function showLoading(text) {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingModal').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingModal').classList.remove('active');
        }

        function switchScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            
            // Scroll to top
            window.scrollTo(0, 0);
        }

        function resetApp() {
            // Clear all data
            vistoriaData = {
                info: {},
                checklist: {},
                startTime: null,
                endTime: null
            };
            
            // Re-initialize
            initializeChecklistData();
            
            // Clear form fields
            document.querySelectorAll('input[type="text"], input[type="number"], textarea').forEach(input => {
                if (!input.readOnly) {
                    input.value = '';
                }
            });
            
            // Reset date and time
            const now = new Date();
            document.getElementById('dataVisita').value = formatDate(now);
            document.getElementById('horaInicio').value = formatTime(now);
        }
    </script>
</body>
</html>